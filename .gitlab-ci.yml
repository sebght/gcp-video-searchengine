variables:
  GOOGLE_REGION: us-central1
  GOOGLE_ZONE: us-central1-a
  FRONT_BUCKET: pulumi.octo-bof-se.ga

stages:
  - build
  - lint
  - test
  - deploy

include:
  - local: '/bof-search-app/gitlab/template_build.yml'
  - local: '/bof-search-app/gitlab/template_lint_and_test.yml'
  - local: '/bof-search-app/gitlab/template_deploy.yml'

build:front:
  extends: .template_build
  before_script:
    - cd bof-search-app/front
  script: # Les scripts exécutés pendant ce job
    - echo "VUE_APP_API_URL = https://${GOOGLE_REGION}-${GCP_PROJECT_ID}.cloudfunctions.net/${GCP_FUNCTION_NAME}" > .env
    - npm install
    - npm run build
  cache: # on définit notre cache
    policy: push
    key: cache_front
    paths:
      - ./bof-search-app/front/dist
      - ./bof-search-app/front/node_modules
  only: # On définit une règle d'exécution : ce job sera fait uniquement sur demo ou en cas de tag
    # refs:
    #   - merge_requests
    changes:
      - "bof-search-app/front/*"


lint:front:
  extends: .template_lint_and_test
  stage: lint # On lie le job au stage de lint
  before_script:
    - cd bof-search-app/front
  script: # Les scripts exécutés pendant ce job
    - npm run lint
  only:
    # refs:
    #   - merge_requests
    changes:
      - "bof-search-app/front/*"

test:unit_front:
  extends: .template_lint_and_test
  stage: test # On lie le job au stage de test
  before_script:
    - cd bof-search-app/front
  script: # Les scripts exécutés pendant ce job
    - npm run test:unit
  only:
    # refs:
    #   - merge_requests
    changes:
      - "bof-search-app/front/*"

deploy:back:
  extends: .template_deploy
  script:
    - cd bof-search-app/back
    - pulumi stack select sebght/bof-search-app/back
    - pulumi refresh
    - npm i
    - pulumi up
  only:
    # refs:
    #   - merge_requests
    changes:
      - "bof-search-app/back/*"

deploy:front:
  extends: .template_deploy
  cache: # Définition des règles de cache pour récuperer les caches de l'étape de build
    key: cache_front
    paths:
      - ./bof-search-app/front/dist
    policy: pull
  script:
    - cd bof-search-app/front/pulumi
    - pulumi stack select sebght/bof-search-app/front
    - npm i
    - pulumi refresh
    - pulumi config set static-website:pathToWebsiteContents ../dist
    - pulumi config set static-website:bucketName ${FRONT_BUCKET}
    - pulumi config set static-website:region ${GOOGLE_REGION}
    - pulumi up
  only:
    # refs:
    #   - merge_requests
    changes:
      - "bof-search-app/front/*"
      