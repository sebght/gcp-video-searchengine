variables:
  GCP_FUNCTION_NAME: helloGet
  GCP_ZONE: us-central1
  FRONT_BUCKET: pulumi.octo-bof-se.ga

stages:
  - build
  - lint
  - test
  - deploy

include:
  - local: '/bof-search-app/gitlab/template_build.yml'
  - local: '/bof-search-app/gitlab/template_lint_and_test.yml'
  - local: '/bof-search-app/gitlab/template_deploy.yml'

build:front:
  extends: .template_build
  before_script:
    - cd bof-search-app/front
  script: # Les scripts exécutés pendant ce job
    - echo "VUE_APP_API_URL = https://${GCP_ZONE}-${GCP_PROJECT_ID}.cloudfunctions.net/${GCP_FUNCTION_NAME}" > .env
    - npm install
    - npm run build
  after_script: # On sauvegarde le fichier package.json dans le répertoire "dist" pour le mettre en cache
    - cp bof-search-app/front/package.json bof-search-app/front/dist/package.json
  cache: # on définit notre cache
    policy: push
    key: node_modules
    paths:
      - ./bof-search-app/front/dist
      - ./bof-search-app/front/node_modules
  only: # On définit une règle d'exécution : ce job sera fait uniquement sur demo ou en cas de tag
    # refs:
    #   - merge_requests
    changes:
      - "bof-search-app/front/*"


lint:front:
  extends: .template_lint_and_test
  stage: lint # On lie le job au stage de lint
  before_script:
    - cd bof-search-app/front
  script: # Les scripts exécutés pendant ce job
    - npm run lint
  only:
    # refs:
    #   - merge_requests
    changes:
      - "bof-search-app/front/*"

test:unit_front:
  extends: .template_lint_and_test
  stage: test # On lie le job au stage de test
  before_script:
    - cd bof-search-app/front
  script: # Les scripts exécutés pendant ce job
    - npm run test:unit
  only:
    # refs:
    #   - merge_requests
    changes:
      - "bof-search-app/front/*"

deploy:back:
  extends: .template_deploy
  script:
    - cd bof-search-app/back
    - pulumi stack select sebght/bof-search-app/back
    - pulumi config set gcf:functionName ${GCP_FUNCTION_NAME}
    - npm i
    - pulumi up
  only:
    # refs:
    #   - merge_requests
    changes:
      - "bof-search-app/back/*"

deploy:front:
  extends: .template_deploy
  script:
    - cd bof-search-app/front
    - pulumi stack select sebght/bof-search-app/front
    - pulumi config set static-website:pathToWebsiteContents ./dist
    - pulumi config set static-website:bucketName ${FRONT_BUCKET}
    - pulumi config set static-website:region ${GCP_ZONE}
    - pulumi up
  only:
    # refs:
    #   - merge_requests
    changes:
      - "bof-search-app/front/*"
      